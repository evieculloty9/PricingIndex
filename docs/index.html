<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Forward Compute Index</title>
<link rel="icon" href="data:,">
<style>
:root{--bg:#0f1216;--panel:#171b21;--muted:#202532;--text:#e7edf3;--sub:#9fb0c3;--accent:#7bd7ff;--ok:#27d980;--warn:#ffa726;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;padding:20px;max-width:1400px;margin:0 auto}
h1{margin:0 0 6px;font-size:28px}
h3{margin:0 0 12px;font-size:18px;font-weight:600}
.small{color:var(--sub);font-size:13px}
.select,select,input,button{background:var(--muted);color:var(--text);border:1px solid #2c3240;border-radius:8px;padding:8px 10px;font:inherit}
select{appearance:none;cursor:pointer}
input{width:100%}
input[type="number"]{text-align:right}
button{cursor:pointer;background:var(--accent);color:#052535;font-weight:600;border:none;transition:opacity .2s}
button:hover{opacity:.85}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:12px;margin-top:12px}
.grid-2{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
.card{background:var(--panel);border:1px solid #222836;border-radius:12px;padding:18px;margin-top:12px}
.center{text-align:center}
.big{font-size:64px;line-height:1;font-weight:800;color:var(--accent);letter-spacing:1px}
.dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--ok);margin-right:6px}
.badge{display:inline-flex;align-items:center;gap:6px;background:#1e2634;border:1px solid #2c3143;border-radius:999px;padding:2px 10px;color:#bcd0e6;font-size:12px;font-weight:500}
.field{display:flex;flex-direction:column;gap:4px;min-width:140px}
.field label{color:var(--sub);font-size:13px;font-weight:500}
.result-box{background:var(--muted);border:1px solid #2c3240;border-radius:8px;padding:14px;margin-top:12px}
.result-value{font-size:24px;font-weight:700;color:var(--accent)}
.result-label{color:var(--sub);font-size:12px;margin-top:4px}
footer{margin-top:24px;color:var(--sub);font-size:12px;text-align:center}
.metric{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #2c3240}
.metric:last-child{border:none}
.metric-label{color:var(--sub)}
.metric-value{font-weight:600}
.positive{color:var(--ok)}
.negative{color:#ff6b6b}
.leaderboard-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--muted);border:1px solid #2c3240;border-radius:8px;margin-bottom:8px}
.rank{width:32px;height:32px;border-radius:50%;background:var(--accent);color:#052535;font-weight:700;display:flex;align-items:center;justify-content:center;margin-right:12px}
.rank.gold{background:#ffd700;color:#000}
.rank.silver{background:#c0c0c0;color:#000}
.rank.bronze{background:#cd7f32;color:#000}
.provider-info{flex:1}
.provider-leader-name{font-weight:600;margin-bottom:2px}
.category-badge{display:inline-block;padding:2px 8px;background:#1e2634;border-radius:4px;font-size:11px;color:var(--sub)}
.insight-card{flex:1;min-width:200px;background:var(--muted);border:1px solid #2c3240;border-radius:8px;padding:12px;display:flex;align-items:center;gap:12px}
.insight-icon{font-size:24px;flex-shrink:0}
.insight-content{flex:1}
.insight-label{font-size:11px;color:var(--sub);margin-bottom:2px}
.insight-value{font-size:16px;font-weight:600;color:var(--text)}
.use-provider-btn{background:var(--accent);color:#052535;border:none;border-radius:4px;padding:4px 8px;font-size:11px;font-weight:600;cursor:pointer;margin-top:4px;transition:opacity .2s}
.use-provider-btn:hover{opacity:.85}
</style>
</head>
<body>
  <h1>Forward Compute Index</h1>
  <div class="small">Real-time regional and category GPU pricing benchmark</div>

  <div class="card center">
    <div id="indexVal" class="big">‚Äì</div>
    <div class="small"><span class="dot"></span>Live Index</div>
    <div id="providerCount" class="small" style="margin-top:8px;font-size:14px">‚Äì providers tracked</div>
    <div id="updated" class="small" style="margin-top:4px">Updated: ‚Äì</div>
    
    <div class="row" style="margin-top:16px;justify-content:center">
      <div class="field">
        <label>Region</label>
        <select id="region" class="select">
          <option>US (All)</option>
          <option>US-East</option>
          <option>US-Central</option>
          <option>US-West</option>
        </select>
      </div>
      <div class="field">
        <label>Category</label>
        <select id="category" class="select">
          <option>All</option>
          <option>Big 3 Hyperscalers</option>
          <option>Major GPU Clouds</option>
          <option>Serverless</option>
          <option>Specialized</option>
        </select>
      </div>
      <button id="btnRefresh" style="align-self:flex-end">Update</button>
    </div>
  </div>

  <!-- Smart Insights -->
  <div class="card" style="background:linear-gradient(135deg, #1a2533 0%, #171b21 100%);border-color:#2a3744">
    <h3 style="margin-bottom:16px">üí° Smart Insights</h3>
    <div id="insights" class="row" style="gap:12px"></div>
  </div>

  <!-- Leaderboards -->
  <div class="grid grid-2">
    <div class="card">
      <h3>üèÜ Cheapest by Category</h3>
      <div id="categoryLeaderboard"></div>
    </div>
    
    <div class="card">
      <h3>üí∞ Overall Cheapest</h3>
      <div id="overallLeaderboard"></div>
    </div>
  </div>

  <!-- Calculators -->
  <div class="grid grid-2">
    <div class="card">
      <h3>Total Cost Calculator</h3>
      
      <div class="field">
        <label>Provider</label>
        <select id="providerSelect" class="select">
          <option value="">Select a provider</option>
        </select>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
        <div class="field">
          <label>GPU Count</label>
          <input id="count" type="number" step="1" value="8" min="1">
        </div>
        <div class="field">
          <label>Duration</label>
          <select id="duration" class="select">
            <option>1 hour</option>
            <option>1 day</option>
            <option>1 week</option>
            <option>1 month</option>
            <option>3 months</option>
            <option>6 months</option>
            <option>1 year</option>
          </select>
        </div>
      </div>

      <div class="result-box">
        <div class="metric">
          <span class="metric-label">Price per GPU-hour</span>
          <span class="metric-value" id="costPrice">‚Äì</span>
        </div>
        <div class="metric">
          <span class="metric-label">Total hours</span>
          <span class="metric-value" id="costHours">‚Äì</span>
        </div>
        <div class="metric">
          <span class="metric-label">GPU-hours</span>
          <span class="metric-value" id="costGPUHours">‚Äì</span>
        </div>
        <div class="metric" style="margin-top:8px;padding-top:12px;border-top:2px solid #2c3240">
          <span class="metric-label" style="font-size:15px;font-weight:600">Total Cost</span>
          <span class="result-value" id="costTotal">‚Äì</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Profit Calculator</h3>
      <div class="small" style="margin-bottom:12px">Calculate profit margins for reselling GPU compute</div>
      
      <div class="field">
        <label>Your selling price ($/GPU-hr)</label>
        <input id="sellingPrice" type="number" step="0.01" value="1.50" min="0">
      </div>

      <div class="result-box">
        <div class="metric">
          <span class="metric-label">Your cost (provider)</span>
          <span class="metric-value" id="profitCost">‚Äì</span>
        </div>
        <div class="metric">
          <span class="metric-label">Your selling price</span>
          <span class="metric-value" id="profitSelling">‚Äì</span>
        </div>
        <div class="metric">
          <span class="metric-label">Profit per GPU-hour</span>
          <span class="metric-value" id="profitPerHour">‚Äì</span>
        </div>
        <div class="metric">
          <span class="metric-label">Profit margin</span>
          <span class="metric-value" id="profitMargin">‚Äì</span>
        </div>
        <div class="metric" style="margin-top:8px;padding-top:12px;border-top:2px solid #2c3240">
          <span class="metric-label" style="font-size:15px;font-weight:600">Total Profit</span>
          <span class="result-value" id="profitTotal">‚Äì</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Workload Estimator -->
  <div class="card">
    <h3>Workload Cost Estimator</h3>
    <div class="small" style="margin-bottom:12px">Compare all providers for your specific workload</div>
    
    <div class="row">
      <div class="field">
        <label>Your workload needs</label>
        <input id="workloadGPUHours" type="number" step="1" value="100" min="1">
      </div>
      <div class="field">
        <label>Unit</label>
        <select id="workloadUnit" class="select">
          <option>GPU-hours</option>
          <option>GPU-days</option>
          <option>GPU-weeks</option>
        </select>
      </div>
      <button id="btnWorkload">Compare All Providers</button>
    </div>

    <div id="workloadResults" class="result-box" style="display:none;margin-top:12px">
      <div style="max-height:400px;overflow-y:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead style="position:sticky;top:0;background:var(--muted);border-bottom:2px solid #2c3240">
            <tr style="text-align:left">
              <th style="padding:8px;color:var(--sub);font-size:13px">Provider</th>
              <th style="padding:8px;color:var(--sub);font-size:13px;text-align:right">Price/GPU-hr</th>
              <th style="padding:8px;color:var(--sub);font-size:13px;text-align:right">Total Cost</th>
              <th style="padding:8px;color:var(--sub);font-size:13px;text-align:right">vs Cheapest</th>
            </tr>
          </thead>
          <tbody id="workloadTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer>Data sources: <code>hcpi/hcpi_latest_full.json</code>, <code>data/derived/provider_scores_latest.csv</code></footer>

<script>
const fmtMoney = n => isFinite(n) ? '$' + Number(n).toFixed(2) : '‚Äì';
const fmtNum = n => isFinite(n) ? Number(n).toLocaleString() : '‚Äì';
const fmtUpdated = iso => {
  try{
    const d = new Date(iso);
    const date = d.toLocaleString(undefined,{month:'short', day:'2-digit'});
    const time = d.toLocaleString(undefined,{hour:'2-digit', minute:'2-digit', hour12:false});
    return `${date}, ${time}`;
  }catch(e){ return iso||'‚Äì'; }
};
const hoursOf = s => {
  s=String(s||'').toLowerCase();
  if (s.includes('year')) return 24*365;
  if (s.includes('6 month')) return 24*30*6;
  if (s.includes('3 month')) return 24*30*3;
  if (s.includes('month')) return 24*30;
  if (s.includes('week'))  return 24*7;
  if (s.includes('day'))   return 24;
  return 1;
};

const PROVIDER_CATEGORY = {
  "Big 3 Hyperscalers": new Set(["AWS","GCP","Azure","Google Cloud","Microsoft Azure"]),
  "Major GPU Clouds":   new Set(["CoreWeave","Lambda Labs","Crusoe","RunPod","Paperspace","FluidStack","Nebius"]),
  "Serverless":         new Set(["Together.ai","Replicate"]),
  "Specialized":        new Set(["Jarvislabs","Vast.ai","OVHcloud","Hyperstack","TensorDock","Voltage Park","Scaleway","Genesis Cloud","SF Compute"])
};

const getCategory = (name) => {
  for (const [cat, set] of Object.entries(PROVIDER_CATEGORY)) {
    for (const v of set) {
      if ((name||'').toLowerCase().includes(v.toLowerCase())) return cat;
    }
  }
  return "Other";
};

const inCategory = (name, cat) => {
  if (cat==='All') return true;
  const set = PROVIDER_CATEGORY[cat]; if(!set) return true;
  for (const v of set) if ((name||'').toLowerCase().includes(v.toLowerCase())) return true;
  return false;
};

let full={}, scores=[], allProviders=[];

async function loadJSON(url){
  try{
    const r=await fetch(url + '?t=' + Date.now());
    if(!r.ok) throw 0;
    return await r.json();
  }catch{ return {}; }
}

async function loadCSV(url){
  try{
    const r = await fetch(url + '?t=' + Date.now()); 
    if(!r.ok) return [];
    const txt = await r.text();
    
    // Split lines and remove BOM if present
    const lines = txt.replace(/^\uFEFF/, '').split(/\r?\n/).map(l => l.trim()).filter(l => l);
    if (!lines.length) return [];
    
    // Parse CSV line respecting quoted fields
    const parseCSVLine = (line) => {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    };
    
    const header = parseCSVLine(lines[0]);
    console.log('CSV Headers:', header);
    console.log('Total lines in CSV:', lines.length);
    
    const rows = [];
    const skipped = [];
    
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i];
      if (!line) continue;
      
      try {
        const cells = parseCSVLine(line);
        const obj = {};
        header.forEach((h, idx) => {
          obj[h] = (cells[idx] || '').replace(/^"|"$/g, '').trim();
        });
        
        obj.provider = (obj.provider || '').trim();
        obj.region = (obj.region || '').trim();
        
        // Parse price - handle any format
        const priceStr = (obj.effective_price_usd_per_gpu_hr || '').trim();
        obj.effective_price_usd_per_gpu_hr = parseFloat(priceStr);
        
        // Only include if we have valid provider and price
        if (obj.provider && isFinite(obj.effective_price_usd_per_gpu_hr) && obj.effective_price_usd_per_gpu_hr > 0) {
          rows.push(obj);
        } else {
          skipped.push({line: i+1, provider: obj.provider, price: priceStr, reason: !obj.provider ? 'no provider' : 'invalid price'});
        }
      } catch (e) {
        console.error('Failed to parse line', i+1, ':', e);
        skipped.push({line: i+1, reason: 'parse error'});
      }
    }
    
    console.log('Loaded rows:', rows.length);
    console.log('Skipped rows:', skipped);
    const uniqueProviders = [...new Set(rows.map(r=>r.provider))].sort();
    console.log('Unique providers:', uniqueProviders);
    console.log('Provider count:', uniqueProviders.length);
    
    return rows;
  }catch(e){ 
    console.error('CSV load error:', e);
    return []; 
  }
}

async function loadAll(){
  [full, scores] = await Promise.all([
    loadJSON('hcpi/hcpi_latest_full.json'),
    loadCSV('data/derived/provider_scores_latest.csv')
  ]);
  
  // Calculate average price per provider across all regions
  const providerMap = new Map();
  scores.forEach(r=>{
    const prov = r.provider;
    const price = r.effective_price_usd_per_gpu_hr;
    if (!prov || !isFinite(price) || price <= 0) return;
    if (!providerMap.has(prov)) providerMap.set(prov, []);
    providerMap.get(prov).push(price);
  });
  
  allProviders = Array.from(providerMap.entries()).map(([name, prices])=>{
    const avg = prices.reduce((a,b)=>a+b,0) / prices.length;
    return {name, avgPrice: avg, category: getCategory(name)};
  }).sort((a,b)=>a.avgPrice-b.avgPrice);
}

function currentIndex(){
  const region = document.getElementById('region').value;
  const cat = document.getElementById('category').value;
  const ts = (full && full.metadata && full.metadata.timestamp) || null;
  document.getElementById('updated').textContent = 'Updated: ' + (ts ? fmtUpdated(ts) : '‚Äì');
  
  // Update provider count
  const uniqueCount = new Set(scores.map(r=>r.provider)).size;
  document.getElementById('providerCount').textContent = `${uniqueCount} providers tracked`;
  
  if (cat !== 'All') {
    const cats = full.category_indices || {};
    const item = cats[cat] || {};
    if (region === 'US (All)' && isFinite(item.category_index)) return item.category_index;
    const byReg = item.regional_indices || {};
    if (isFinite(byReg[region])) return byReg[region];
    if (isFinite(item.category_index)) return item.category_index;
    return NaN;
  }
  if (region === 'US (All)') {
    return isFinite(full.us_index) ? full.us_index : NaN;
  } else {
    const reg = full.regional_indices ? full.regional_indices[region] : undefined;
    return isFinite(reg) ? reg : NaN;
  }
}

function renderIndex(){
  const val = currentIndex();
  document.getElementById('indexVal').textContent = isFinite(val) ? fmtMoney(val) : '‚Äì';
}

function renderLeaderboards(){
  // Category leaders
  const categories = ["Big 3 Hyperscalers", "Major GPU Clouds", "Serverless", "Specialized"];
  const categoryHTML = categories.map(cat=>{
    const inCat = allProviders.filter(p=>p.category===cat);
    if (!inCat.length) return '';
    const leader = inCat[0];
    return `
      <div class="leaderboard-item" style="cursor:pointer" onclick="useProvider('${leader.name}', ${leader.avgPrice})">
        <div class="rank gold">1</div>
        <div class="provider-info">
          <div class="provider-leader-name">${leader.name}</div>
          <div class="category-badge">${cat}</div>
        </div>
        <div style="font-size:20px;font-weight:700;color:var(--accent)">${fmtMoney(leader.avgPrice)}</div>
      </div>
    `;
  }).join('');
  document.getElementById('categoryLeaderboard').innerHTML = categoryHTML || '<div class="small">No data</div>';
  
  // Overall top 5
  const top5 = allProviders.slice(0,5);
  const overallHTML = top5.map((p,i)=>{
    const rankClass = i===0 ? 'gold' : i===1 ? 'silver' : i===2 ? 'bronze' : '';
    return `
      <div class="leaderboard-item" style="cursor:pointer" onclick="useProvider('${p.name}', ${p.avgPrice})">
        <div class="rank ${rankClass}">${i+1}</div>
        <div class="provider-info">
          <div class="provider-leader-name">${p.name}</div>
          <div class="category-badge">${p.category}</div>
        </div>
        <div style="font-size:20px;font-weight:700;color:var(--accent)">${fmtMoney(p.avgPrice)}</div>
      </div>
    `;
  }).join('');
  document.getElementById('overallLeaderboard').innerHTML = overallHTML || '<div class="small">No data</div>';
}

function useProvider(name, price){
  const sel = document.getElementById('providerSelect');
  sel.value = name;
  calculateCost();
  calculateProfit();
  // Smooth scroll to calculator
  document.getElementById('providerSelect').scrollIntoView({behavior: 'smooth', block: 'center'});
}

window.useProvider = useProvider;

function renderInsights(){
  if (!allProviders.length) return;
  
  const cheapest = allProviders[0];
  const mostExpensive = allProviders[allProviders.length - 1];
  const avgPrice = allProviders.reduce((sum, p) => sum + p.avgPrice, 0) / allProviders.length;
  const spread = mostExpensive.avgPrice - cheapest.avgPrice;
  const spreadPct = ((spread / mostExpensive.avgPrice) * 100).toFixed(0);
  
  // Find best value in popular category
  const majorGPU = allProviders.filter(p => p.category === "Major GPU Clouds").sort((a,b) => a.avgPrice - b.avgPrice)[0];
  
  const insights = [
    {
      icon: '‚ö°',
      label: 'Cheapest Provider',
      value: `${cheapest.name} ‚Ä¢ ${fmtMoney(cheapest.avgPrice)}/hr`,
      action: `<button class="use-provider-btn" onclick="useProvider('${cheapest.name}', ${cheapest.avgPrice})">Use This</button>`
    },
    {
      icon: 'üìä',
      label: 'Market Average',
      value: `${fmtMoney(avgPrice)}/hr`,
      subtext: `${spreadPct}% price spread across providers`
    },
    {
      icon: 'üèÜ',
      label: 'Best Value (Major Clouds)',
      value: majorGPU ? `${majorGPU.name} ‚Ä¢ ${fmtMoney(majorGPU.avgPrice)}/hr` : 'N/A',
      action: majorGPU ? `<button class="use-provider-btn" onclick="useProvider('${majorGPU.name}', ${majorGPU.avgPrice})">Use This</button>` : ''
    },
    {
      icon: 'üí∞',
      label: 'Potential Savings',
      value: `${fmtMoney(avgPrice - cheapest.avgPrice)}/GPU-hr`,
      subtext: `vs market average`
    }
  ];
  
  const html = insights.map(i => `
    <div class="insight-card">
      <div class="insight-icon">${i.icon}</div>
      <div class="insight-content">
        <div class="insight-label">${i.label}</div>
        <div class="insight-value">${i.value}</div>
        ${i.subtext ? `<div style="font-size:11px;color:var(--sub);margin-top:2px">${i.subtext}</div>` : ''}
        ${i.action || ''}
      </div>
    </div>
  `).join('');
  
  document.getElementById('insights').innerHTML = html;
}

function renderProviderDropdown(){
  const sel = document.getElementById('providerSelect');
  sel.innerHTML = '<option value="">Select a provider</option>' + 
    allProviders.map(p=>`<option value="${p.name}" data-price="${p.avgPrice}">${p.name} - ${fmtMoney(p.avgPrice)}/hr</option>`).join('');
}

function calculateCost(){
  const sel = document.getElementById('providerSelect');
  const selectedOption = sel.options[sel.selectedIndex];
  if (!selectedOption || !selectedOption.value) {
    document.getElementById('costPrice').textContent = '‚Äì';
    document.getElementById('costHours').textContent = '‚Äì';
    document.getElementById('costGPUHours').textContent = '‚Äì';
    document.getElementById('costTotal').textContent = '‚Äì';
    return null;
  }
  
  const price = parseFloat(selectedOption.dataset.price);
  const count = Number(document.getElementById('count').value) || 0;
  const dur = document.getElementById('duration').value;
  const hrs = hoursOf(dur);
  const gpuHours = count * hrs;
  const totalCost = price * gpuHours;
  
  document.getElementById('costPrice').textContent = fmtMoney(price) + '/hr';
  document.getElementById('costHours').textContent = fmtNum(hrs) + ' hrs';
  document.getElementById('costGPUHours').textContent = fmtNum(gpuHours);
  document.getElementById('costTotal').textContent = fmtMoney(totalCost);
  
  return {price, totalCost, gpuHours};
}

function calculateProfit(){
  const costData = calculateCost();
  if (!costData) {
    document.getElementById('profitCost').textContent = '‚Äì';
    document.getElementById('profitSelling').textContent = '‚Äì';
    document.getElementById('profitPerHour').textContent = '‚Äì';
    document.getElementById('profitMargin').textContent = '‚Äì';
    document.getElementById('profitTotal').textContent = '‚Äì';
    return;
  }
  
  const sellingPrice = Number(document.getElementById('sellingPrice').value) || 0;
  const profitPerHour = sellingPrice - costData.price;
  const totalProfit = profitPerHour * costData.gpuHours;
  const margin = sellingPrice > 0 ? (profitPerHour / sellingPrice) * 100 : 0;
  
  document.getElementById('profitCost').textContent = fmtMoney(costData.price) + '/hr';
  document.getElementById('profitSelling').textContent = fmtMoney(sellingPrice) + '/hr';
  
  const perHourEl = document.getElementById('profitPerHour');
  perHourEl.textContent = fmtMoney(profitPerHour) + '/hr';
  perHourEl.className = 'metric-value ' + (profitPerHour >= 0 ? 'positive' : 'negative');
  
  const marginEl = document.getElementById('profitMargin');
  marginEl.textContent = margin.toFixed(1) + '%';
  marginEl.className = 'metric-value ' + (margin >= 0 ? 'positive' : 'negative');
  
  const totalEl = document.getElementById('profitTotal');
  totalEl.textContent = fmtMoney(totalProfit);
  totalEl.className = 'result-value ' + (totalProfit >= 0 ? 'positive' : 'negative');
}

function calculateWorkload(){
  const workloadInput = Number(document.getElementById('workloadGPUHours').value) || 0;
  const unit = document.getElementById('workloadUnit').value;
  let gpuHours = workloadInput;
  if (unit.includes('days')) gpuHours *= 24;
  if (unit.includes('weeks')) gpuHours *= 24 * 7;
  if (gpuHours <= 0) { document.getElementById('workloadResults').style.display = 'none'; return; }
  
  const results = allProviders.map(p => ({
    name: p.name,
    pricePerHr: p.avgPrice,
    totalCost: p.avgPrice * gpuHours
  })).sort((a,b)=>a.totalCost-b.totalCost);
  
  const cheapest = results[0].totalCost;
  const tbody = document.getElementById('workloadTableBody');
  tbody.innerHTML = results.map((r,i)=>{
    const diff = r.totalCost - cheapest;
    const diffPct = cheapest>0 ? (diff/cheapest)*100 : 0;
    const isCheapest = i===0;
    return `<tr style="border-bottom:1px solid #2c3240">
        <td style="padding:8px">${isCheapest?'<span style="color:var(--ok);margin-right:4px">‚òÖ</span>':''}${r.name}</td>
        <td style="padding:8px;text-align:right">${fmtMoney(r.pricePerHr)}</td>
        <td style="padding:8px;text-align:right;font-weight:600">${fmtMoney(r.totalCost)}</td>
        <td style="padding:8px;text-align:right;color:${isCheapest?'var(--ok)': diff>cheapest*0.5?'#ff6b6b':'var(--warn)'}">${isCheapest?'Cheapest':'+'+fmtMoney(diff)+' (+'+diffPct.toFixed(0)+'%)'}</td>
      </tr>`;
  }).join('');
  
  document.getElementById('workloadResults').style.display = 'block';
}

function setupListeners(){
  document.getElementById('region').addEventListener('change', renderIndex);
  document.getElementById('category').addEventListener('change', renderIndex);
  document.getElementById('btnRefresh').addEventListener('click', renderIndex);
  
  document.getElementById('providerSelect').addEventListener('change', ()=>{
    calculateCost();
    calculateProfit();
  });
  document.getElementById('count').addEventListener('input', ()=>{
    calculateCost();
    calculateProfit();
  });
  document.getElementById('duration').addEventListener('change', ()=>{
    calculateCost();
    calculateProfit();
  });
  document.getElementById('sellingPrice').addEventListener('input', calculateProfit);
  
  document.getElementById('btnWorkload').addEventListener('click', calculateWorkload);
  document.getElementById('workloadGPUHours').addEventListener('input', calculateWorkload);
  document.getElementById('workloadUnit').addEventListener('change', calculateWorkload);
}

async function boot(){
  await loadAll();
  renderIndex();
  renderLeaderboards();
  renderProviderDropdown();
  setupListeners();
}
boot();
</script>
</body>
</html> 

