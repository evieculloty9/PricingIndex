<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Forward Compute Index</title>
<link rel="icon" href="data:,">
<style>
:root{--bg:#0f1216;--panel:#171b21;--muted:#202532;--text:#e7edf3;--sub:#9fb0c3;--accent:#7bd7ff;--ok:#27d980;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;padding:20px}
h1{margin:0 0 6px;font-size:28px}
.small{color:var(--sub);font-size:13px}
.select,select,input,button{background:var(--muted);color:var(--text);border:1px solid #2c3240;border-radius:8px;padding:8px 10px;font:inherit}
select{appearance:none}
input[readonly]{opacity:.75}
button{cursor:pointer;background:var(--accent);color:#052535;font-weight:700;border:none}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.card{background:var(--panel);border:1px solid #222836;border-radius:12px;padding:16px;margin-top:12px}
.center{text-align:center}
.big{font-size:64px;line-height:1;font-weight:800;color:var(--accent);letter-spacing:1px}
.dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--ok);margin-right:6px}
.badge{display:inline-flex;align-items:center;gap:6px;background:#1e2634;border:1px solid #2c3143;border-radius:999px;padding:2px 10px;color:#bcd0e6;font-size:12px}
footer{margin-top:16px;color:var(--sub);font-size:12px}
</style>
</head>
<body>
  <h1>Forward Compute Index</h1>
  <div class="small">Real-time regional and category GPU pricing benchmark</div>

  <div class="row" style="margin-top:10px">
    <label class="small">Region</label>
    <select id="region" class="select">
      <option>US-East</option>
      <option>US-Central</option>
      <option>US-West</option>
      <option>US (All)</option>
    </select>

    <label class="small">Category</label>
    <select id="category" class="select">
      <option>All</option>
      <option>Big 3 Hyperscalers</option>
      <option>Major GPU Clouds</option>
      <option>Serverless</option>
      <option>Specialized</option>
    </select>

    <button id="btnRefresh">Update</button>
  </div>

  <div class="card center">
    <div id="indexVal" class="big">–</div>
    <div class="small"><span class="dot"></span>Live</div>
    <div id="updated" class="small" style="margin-top:4px">Updated: –</div>
  </div>

  <!-- =================== TOTAL COST (Provider-driven) =================== -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <h3 style="margin:0">Total Cost Calculator</h3>
      <span class="badge" id="calcSliceBadge">–</span>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <div class="small" style="margin-bottom:4px">Provider</div>
        <select id="provSelect" class="select" style="min-width:240px"></select>
      </div>

      <div>
        <div class="small" style="margin-bottom:4px">Price $/GPU-hr</div>
        <input id="price" class="select" type="number" step="0.01" readonly placeholder="auto">
      </div>

      <div>
        <div class="small" style="margin-bottom:4px">GPU count</div>
        <input id="count" class="select" type="number" step="1" value="8">
      </div>

      <div>
        <div class="small" style="margin-bottom:4px">Duration</div>
        <select id="duration" class="select">
          <option>1 hour</option>
          <option>1 day</option>
          <option>1 week</option>
          <option>1 month</option>
        </select>
      </div>

      <button id="btnCost">Calculate</button>
    </div>

    <div id="calcSummary" class="small" style="margin-top:8px">Select a provider to estimate cost.</div>
  </div>

  <!-- =================== ROI (Calculator) =================== -->
  <div class="card">
    <h3 style="margin:0 0 8px">ROI Estimator</h3>
    <div class="row">
      <div>
        <div class="small" style="margin-bottom:4px">Revenue $/GPU-hr</div>
        <input id="revenue" class="select" type="number" step="0.01" value="0.68">
      </div>
      <div>
        <div class="small" style="margin-bottom:4px">Utilisation (0–1)</div>
        <input id="util" class="select" type="number" step="0.01" value="0.70">
      </div>
      <button id="btnROI">Estimate ROI</button>
    </div>
    <div id="roiOut" class="small" style="margin-top:8px">ROI: –</div>
  </div>

  <footer>Data sources: <code>hcpi/hcpi_dashboard.json</code>, <code>hcpi/hcpi_latest_full.json</code>, <code>data/derived/provider_scores_latest.csv</code></footer>

<script>
/* =================== Utils =================== */
const fmtMoney = n => isFinite(n) ? '$' + Number(n).toFixed(2) : '–';
const fmtUpdated = iso => {
  try{
    const d = new Date(iso);
    const date = d.toLocaleString(undefined,{month:'short', day:'2-digit'});
    const time = d.toLocaleString(undefined,{hour:'2-digit', minute:'2-digit', hour12:false, timeZoneName:'short'});
    return `${date}, ${time}`;
  }catch(e){ return iso||'–'; }
};
const hoursOf = s => {
  s=String(s||'').toLowerCase();
  if (s.includes('month')) return 24*30;
  if (s.includes('week'))  return 24*7;
  if (s.includes('day'))   return 24;
  return 1;
};

/* Provider categories (loose match set) */
const PROVIDER_CATEGORY = {
  "Big 3 Hyperscalers": new Set(["AWS","GCP","Azure","Google Cloud","Microsoft Azure"]),
  "Major GPU Clouds":   new Set(["CoreWeave","Lambda Labs","Crusoe","Crusoe Cloud","RunPod","Paperspace","FluidStack","Nebius"]),
  "Serverless":         new Set(["Together.ai","Replicate","Together .ai"]),
  "Specialized":        new Set(["Jarvislabs","Vast.ai","OVHcloud","OVH Cloud","Hyperstack","TensorDock","Voltage Park","Scaleway","Genesis Cloud","SF Compute"])
};
const inCategory = (name, cat) => {
  if (cat==='All') return true;
  const set = PROVIDER_CATEGORY[cat]; if(!set) return true;
  for (const v of set) if ((name||'').toLowerCase().includes(v.toLowerCase())) return true;
  return false;
};

/* =================== Data =================== */
let dash={}, full={}, scores=[];

async function loadJSON(url){ try{ const r=await fetch(url); if(!r.ok) throw 0; return await r.json(); }catch{ return {}; } }
async function loadCSV(url){
  try{
    const r = await fetch(url); if(!r.ok) return [];
    const txt = await r.text();
    const lines = txt.replace(/^\uFEFF/,'').trim().split(/\r?\n/);
    const header = lines.shift().split(',').map(h=>h.trim());
    return lines.filter(Boolean).map(line=>{
      const cells = line.split(','); const o={};
      header.forEach((h,i)=> o[h]= (cells[i]??'').trim() );
      o.gpu_count = Number(o.gpu_count||o.gpus||0);
      o.effective_price_usd_per_gpu_hr = Number(o.effective_price_usd_per_gpu_hr||o["$/GPU-hr"]||o.price||NaN);
      return o;
    });
  }catch{ return []; }
}

async function loadAll(){
  [dash, full, scores] = await Promise.all([
    loadJSON('hcpi/hcpi_dashboard.json'),
    loadJSON('hcpi/hcpi_latest_full.json'),
    loadCSV('data/derived/provider_scores_latest.csv')
  ]);
}

/* =================== Index =================== */
function currentIndex(){
  const region = document.getElementById('region').value;
  const cat    = document.getElementById('category').value;

  const ts = (dash && dash.timestamp) || (full && full.metadata && full.metadata.timestamp) || null;
  document.getElementById('updated').textContent = 'Updated: ' + (ts ? fmtUpdated(ts) : '–');

  if (cat !== 'All') {
    const cats = (full && full.category_indices) || {};
    const item = cats[cat] || {};
    if (region === 'US (All)') { if (isFinite(item.category_index)) return item.category_index; }
    else {
      const byReg = item.regional_indices || {};
      if (isFinite(byReg[region])) return byReg[region];
    }
    if (isFinite(item.category_index)) return item.category_index;
    return NaN;
  }

  if (region === 'US (All)') {
    return dash && isFinite(dash.us_index) ? dash.us_index :
           (full && isFinite(full.us_index) ? full.us_index : NaN);
  } else {
    if (dash && dash.regions && isFinite(dash.regions[region])) return dash.regions[region];
    const reg = full && full.regional_indices ? full.regional_indices[region] : undefined;
    return isFinite(reg) ? reg : NaN;
  }
}
function renderIndex(){ document.getElementById('indexVal').textContent = fmtMoney(currentIndex()); }

/* =================== Provider dropdown + pricing =================== */
function refreshProviderDropdown(){
  const region = document.getElementById('region').value;
  const cat    = document.getElementById('category').value;
  const sel    = document.getElementById('provSelect');

  // distinct provider list for current slice
  const seen = new Set(), list=[];
  scores.forEach(r=>{
    const prov = r.provider||''; const reg=r.region||'';
    if (!prov) return;
    if (region!=='US (All)' && reg!==region) return;
    if (!inCategory(prov, cat)) return;
    if (!seen.has(prov)){ seen.add(prov); list.push(prov); }
  });
  list.sort((a,b)=>a.localeCompare(b));
  sel.innerHTML = ['<option value="" disabled selected>Select provider</option>']
                  .concat(list.map(p=>`<option>${p}</option>`)).join('');

  document.getElementById('calcSliceBadge').textContent = `${region} • ${cat}`;
  document.getElementById('price').value = '';
  document.getElementById('calcSummary').textContent = 'Select a provider to estimate cost.';
}

function medianPriceForProvider(prov, region){
  // Prefer region + on-demand + 1h → then relax progressively
  let rows = scores.filter(r => (r.provider||'').toLowerCase()===prov.toLowerCase());
  if (!rows.length) return NaN;

  const byRegion = region==='US (All)' ? rows : rows.filter(r=>r.region===region);
  rows = byRegion.length ? byRegion : rows;

  let pref = rows.filter(r=>String(r.type||'').toLowerCase().includes('on') && /(^1 ?h)|(^1 ?hour)/i.test(r.duration||''));
  if (!pref.length) pref = rows.filter(r=>String(r.type||'').toLowerCase().includes('on'));
  const pool = pref.length ? pref : rows;

  const prices = pool.map(r=>r.effective_price_usd_per_gpu_hr).filter(Number.isFinite).sort((a,b)=>a-b);
  if (!prices.length) return NaN;
  return prices[Math.floor(prices.length/2)];
}

function onProviderChange(){
  const prov = document.getElementById('provSelect').value;
  if (!prov) return;
  const region = document.getElementById('region').value;
  const p = medianPriceForProvider(prov, region);
  document.getElementById('price').value = isFinite(p) ? p.toFixed(2) : '';
  calcCost(); // live update
}

/* =================== Calculators =================== */
function calcCost(){
  const prov  = document.getElementById('provSelect').value;
  const price = Number(document.getElementById('price').value)||0;
  const count = Number(document.getElementById('count').value)||0;
  const dur   = document.getElementById('duration').value;
  const hrs   = hoursOf(dur);
  if (!prov || !(price>0)){ document.getElementById('calcSummary').textContent='Select a provider (price auto-filled)'; return; }
  const total = price * count * hrs;
  document.getElementById('calcSummary').textContent =
    `Total cost: ${fmtMoney(total)} — ${prov} • ${count} GPU × ${dur} × ${fmtMoney(price).replace('$','$/')}/hr`;
}

function calcROI(){
  // ROI model: revenue vs cost, using current provider price, user revenue & utilisation
  const price = Number(document.getElementById('price').value)||0;      // $/GPU-hr (from provider)
  const rev   = Number(document.getElementById('revenue').value)||0;    // $/GPU-hr
  const util  = Number(document.getElementById('util').value)||0;       // 0–1
  const count = Number(document.getElementById('count').value)||0;
  const hrs   = hoursOf(document.getElementById('duration').value);

  const out   = document.getElementById('roiOut');
  if (!(price>0) || !(rev>0) || !(util>=0)){ out.textContent='ROI: select provider and enter revenue/utilisation'; return; }

  const cost    = price * count * hrs;
  const revenue = rev   * util  * count * hrs;
  const roiPct  = cost>0 ? ((revenue - cost)/cost)*100 : NaN;

  out.textContent = `ROI: ${isFinite(roiPct)?roiPct.toFixed(1)+'%':'–'}  ·  Revenue ${fmtMoney(revenue)}  ·  Cost ${fmtMoney(cost)}`;
}

/* =================== Boot =================== */
async function boot(){
  await loadAll();
  renderIndex();
  refreshProviderDropdown();

  // filters
  document.getElementById('region').addEventListener('change', ()=>{ renderIndex(); refreshProviderDropdown(); });
  document.getElementById('category').addEventListener('change', ()=>{ renderIndex(); refreshProviderDropdown(); });
  document.getElementById('btnRefresh').addEventListener('click', ()=>{ renderIndex(); refreshProviderDropdown(); });

  // calculators
  document.getElementById('provSelect').addEventListener('change', onProviderChange);
  document.getElementById('btnCost').addEventListener('click', calcCost);
  document.getElementById('btnROI').addEventListener('click', calcROI);
}
boot();
</script>
</body>
</html>


