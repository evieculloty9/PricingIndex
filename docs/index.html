<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Forward Compute Index</title>
<link rel="icon" href="data:,">
<!-- Chart.js + time adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<style>
:root{--bg:#0f1216;--panel:#171b21;--muted:#202532;--text:#e7edf3;--sub:#9fb0c3;--accent:#7bd7ff;--ok:#27d980;--warn:#ffa726;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;padding:20px;max-width:1400px;margin:0 auto}
h1{margin:0 0 6px;font-size:28px}
h3{margin:0 0 12px;font-size:18px;font-weight:600}
.small{color:var(--sub);font-size:13px}
.select,select,input,button{background:var(--muted);color:var(--text);border:1px solid #2c3240;border-radius:8px;padding:8px 10px;font:inherit}
select{appearance:none;cursor:pointer}
input{width:100%}
input[type="number"]{text-align:right}
button{cursor:pointer;background:var(--accent);color:#052535;font-weight:600;border:none;transition:opacity .2s}
button:hover{opacity:.85}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:12px;margin-top:12px}
.grid-2{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
.card{background:var(--panel);border:1px solid #222836;border-radius:12px;padding:18px;margin-top:12px}
.center{text-align:center}
.big{font-size:64px;line-height:1;font-weight:800;color:var(--accent);letter-spacing:1px}
.dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--ok);margin-right:6px}
.badge{display:inline-flex;align-items:center;gap:6px;background:#1e2634;border:1px solid #2c3143;border-radius:999px;padding:2px 10px;color:#bcd0e6;font-size:12px;font-weight:500}
.field{display:flex;flex-direction:column;gap:4px;min-width:140px}
.field label{color:var(--sub);font-size:13px;font-weight:500}
.result-box{background:var(--muted);border:1px solid #2c3240;border-radius:8px;padding:14px;margin-top:12px}
.result-value{font-size:24px;font-weight:700;color:var(--accent)}
.metric{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #2c3240}
.metric:last-child{border:none}
.metric-label{color:var(--sub)}
.metric-value{font-weight:600}
.positive{color:var(--ok)}
.negative{color:#ff6b6b}
.leaderboard-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--muted);border:1px solid #2c3240;border-radius:8px;margin-bottom:8px}
.rank{width:32px;height:32px;border-radius:50%;background:var(--accent);color:#052535;font-weight:700;display:flex;align-items:center;justify-content:center;margin-right:12px}
.rank.gold{background:#ffd700;color:#000}
.rank.silver{background:#c0c0c0;color:#000}
.rank.bronze{background:#cd7f32;color:#000}
.provider-info{flex:1}
.provider-leader-name{font-weight:600;margin-bottom:2px}
.category-badge{display:inline-block;padding:2px 8px;background:#1e2634;border-radius:4px;font-size:11px;color:var(--sub)}
.insight-card{flex:1;min-width:200px;background:var(--muted);border:1px solid #2c3240;border-radius:8px;padding:12px;display:flex;align-items:center;gap:12px}
.insight-icon{font-size:24px;flex-shrink:0}
.insight-content{flex:1}
.insight-label{font-size:11px;color:var(--sub);margin-bottom:2px}
.insight-value{font-size:16px;font-weight:600;color:var(--text)}
footer{margin-top:24px;color:var(--sub);font-size:12px;text-align:center}

/* Pills for range selector */
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{background:#0e1218;border:1px solid #2a3040;color:#b9c7d7;border-radius:12px;padding:8px 12px;font-size:13px;cursor:pointer;user-select:none}
.pill.active{background:#111722;border-color:#3a4256;box-shadow:inset 0 0 0 2px #1a2130;color:#e7edf3}
.chartHeader{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.chartSub{color:var(--sub);font-size:12px}
</style>
</head>
<body>
  <h1>Forward Compute Index</h1>
  <div class="small">Real-time regional and category GPU pricing benchmark</div>

  <div class="card center">
    <div id="indexVal" class="big">‚Äì</div>
    <div class="small"><span class="dot"></span>Live Index</div>
    <div id="providerCount" class="small" style="margin-top:8px;font-size:14px">‚Äì providers tracked</div>
    <div id="updated" class="small" style="margin-top:4px">Updated: ‚Äì</div>
    
    <div class="row" style="margin-top:16px;justify-content:center">
      <div class="field">
        <label>Region</label>
        <select id="region" class="select">
          <option>US (All)</option>
          <option>US-East</option>
          <option>US-Central</option>
          <option>US-West</option>
        </select>
      </div>
      <div class="field">
        <label>Category</label>
        <select id="category" class="select">
          <option>All</option>
          <option>Big 3 Hyperscalers</option>
          <option>Major GPU Clouds</option>
          <option>Serverless</option>
          <option>Specialized</option>
        </select>
      </div>
      <button id="btnRefresh" style="align-self:flex-end">Update</button>
    </div>
  </div>

  <!-- ================= Index History (overall) ================= -->
  <div class="card">
    <div class="chartHeader">
      <h3 style="margin:0">Index ‚Äî History</h3>
      <span id="hcpiPts" class="chartSub">‚Äì data points</span>
      <div style="margin-left:auto" class="pills" id="rangePills">
        <div class="pill" data-range="1H">1H</div>
        <div class="pill" data-range="4H">4H</div>
        <div class="pill" data-range="12H">12H</div>
        <div class="pill active" data-range="1D">1D</div>
        <div class="pill" data-range="3D">3D</div>
        <div class="pill" data-range="1W">1W</div>
        <div class="pill" data-range="1M">1M</div>
        <div class="pill" data-range="3M">3M</div>
        <div class="pill" data-range="ALL">All</div>
      </div>
    </div>
    <div style="height:320px">
      <canvas id="hcpiHistory"></canvas>
    </div>
  </div>
  <!-- ========================================================== -->

  <!-- Smart Insights -->
  <div class="card" style="background:linear-gradient(135deg, #1a2533 0%, #171b21 100%);border-color:#2a3744">
    <h3 style="margin-bottom:16px">üí° Smart Insights</h3>
    <div id="insights" class="row" style="gap:12px"></div>
  </div>

  <!-- Leaderboards -->
  <div class="grid grid-2">
    <div class="card">
      <h3>üèÜ Cheapest by Category</h3>
      <div id="categoryLeaderboard"></div>
    </div>
    
    <div class="card">
      <h3>üí∞ Overall Cheapest</h3>
      <div id="overallLeaderboard"></div>
    </div>
  </div>

  <!-- Calculators -->
  <div class="grid grid-2">
    <div class="card">
      <h3>Total Cost Calculator</h3>
      
      <div class="field">
        <label>Provider</label>
        <select id="providerSelect" class="select">
          <option value="">Select a provider</option>
        </select>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
        <div class="field">
          <label>GPU Count</label>
          <input id="count" type="number" step="1" value="8" min="1">
        </div>
        <div class="field">
          <label>Duration</label>
          <select id="duration" class="select">
            <option>1 hour</option>
            <option>1 day</option>
            <option>1 week</option>
            <option>1 month</option>
            <option>3 months</option>
            <option>6 months</option>
            <option>1 year</option>
          </select>
        </div>
      </div>

      <div class="result-box">
        <div class="metric">
          <span class="metric-label">Price per GPU-hour</span>
          <span class="metric-value" id="costPrice">‚Äì</span>
        </div>
        <div class="metric">
          <span class="metric-label">Total hours</span>
          <span class="metric-value" id="costHours">‚Äì</span>
        </div>
        <div class="metric">
          <span class="metric-label">GPU-hours</span>
          <span class="metric-value" id="costGPUHours">‚Äì</span>
        </div>
        <div class="metric" style="margin-top:8px;padding-top:12px;border-top:2px solid #2c3240">
          <span class="metric-label" style="font-size:15px;font-weight:600">Total Cost</span>
          <span class="result-value" id="costTotal">‚Äì</span>
        </div>
      </div>
    </div>

    <!-- ROI (value per dollar = 1 / price) -->
    <div class="card">
      <h3>ROI (Value per Dollar)</h3>
      <div class="small" style="margin-bottom:12px">
        ROI = <code>1 / price_per_gpu_hour</code> ‚Üí GPU-hours per $1 (higher is better).
      </div>

      <div class="result-box">
        <div class="metric">
          <span class="metric-label">Selected provider price</span>
          <span class="metric-value" id="roiProviderPrice">‚Äì</span>
        </div>
        <div class="metric">
          <span class="metric-label">ROI (GPU-hrs per $)</span>
          <span class="metric-value" id="roiBasic">‚Äì</span>
        </div>
        <div class="metric">
          <span class="metric-label">Rank vs all providers</span>
          <span class="metric-value" id="roiRank">‚Äì</span>
        </div>
        <div class="metric" id="roiUtilRow" style="display:none">
          <span class="metric-label">Utilisation-adjusted ROI</span>
          <span class="metric-value" id="roiUtil">‚Äì</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Workload Estimator -->
  <div class="card">
    <h3>Workload Cost Estimator</h3>
    <div class="small" style="margin-bottom:12px">Compare all providers for your specific workload</div>
    
    <div class="row">
      <div class="field">
        <label>Your workload needs</label>
        <input id="workloadGPUHours" type="number" step="1" value="100" min="1">
      </div>
      <div class="field">
        <label>Unit</label>
        <select id="workloadUnit" class="select">
          <option>GPU-hours</option>
          <option>GPU-days</option>
          <option>GPU-weeks</option>
        </select>
      </div>
      <button id="btnWorkload">Compare All Providers</button>
    </div>

    <div id="workloadResults" class="result-box" style="display:none;margin-top:12px">
      <div style="max-height:400px;overflow-y:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead style="position:sticky;top:0;background:var(--muted);border-bottom:2px solid #2c3240">
            <tr style="text-align:left">
              <th style="padding:8px;color:var(--sub);font-size:13px">Provider</th>
              <th style="padding:8px;color:var(--sub);font-size:13px;text-align:right">Price/GPU-hr</th>
              <th style="padding:8px;color:var(--sub);font-size:13px;text-align:right">Total Cost</th>
              <th style="padding:8px;color:var(--sub);font-size:13px;text-align:right">vs Cheapest</th>
            </tr>
          </thead>
          <tbody id="workloadTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer>Data sources: <code>hcpi/hcpi_latest_full.json</code>, <code>hcpi/hcpi_history.json</code>, <code>data/derived/provider_scores_latest.csv</code></footer>

<!-- ===================== HISTORY CHART SCRIPT ===================== -->
<script>
let hcpiChart, hcpiAllPoints = [];

const RANGES = {
  "1H": 60*60*1000,
  "4H": 4*60*60*1000,
  "12H": 12*60*60*1000,
  "1D": 24*60*60*1000,
  "3D": 3*24*60*60*1000,
  "1W": 7*24*60*60*1000,
  "1M": 30*24*60*60*1000,
  "3M": 90*24*60*60*1000,
  "ALL": Infinity
};

async function loadHistory() {
  const r = await fetch('hcpi/hcpi_history.json?t=' + Date.now());
  if (!r.ok) return [];
  const data = await r.json();
  return (Array.isArray(data) ? data : [])
    .map(d => ({ x: new Date(d.timestamp), y: Number(d.us_index ?? d.US ?? NaN) }))
    .filter(p => isFinite(p.y));
}

function setActivePill(key){
  document.querySelectorAll('#rangePills .pill').forEach(el=>{
    el.classList.toggle('active', el.dataset.range === key);
  });
}

function applyRange(key){
  setActivePill(key);
  const now = Date.now();
  const windowMs = RANGES[key] ?? RANGES["1D"];
  const data = windowMs === Infinity
    ? hcpiAllPoints
    : hcpiAllPoints.filter(p => now - p.x.getTime() <= windowMs);

  const pts = data.length;
  document.getElementById('hcpiPts').textContent =
    (pts ? pts : '0') + ' data points ‚Ä¢ ' + key;

  hcpiChart.data.datasets[0].data = data;
  hcpiChart.update();
}

async function initHistoryChart() {
  hcpiAllPoints = await loadHistory();

  const ctx = document.getElementById('hcpiHistory').getContext('2d');
  const gradient = ctx.createLinearGradient(0,0,0,300);
  gradient.addColorStop(0, 'rgba(123,215,255,0.35)');
  gradient.addColorStop(1, 'rgba(123,215,255,0.02)');

  hcpiChart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        label: 'US Index',
        data: [],
        borderColor: 'rgba(123,215,255,0.9)',
        backgroundColor: gradient,
        fill: true,
        borderWidth: 2,
        tension: 0.3,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          type: 'time',
          time: { tooltipFormat: 'MMM d, HH:mm' },
          grid: { color: 'rgba(255,255,255,0.05)' },
          ticks: { color: '#9fb0c3' }
        },
        y: {
          title: { display: true, text: '$ per GPU-hour' },
          grid: { color: 'rgba(255,255,255,0.06)' },
          ticks: { color: '#9fb0c3' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => '$' + (ctx.parsed.y ?? 0).toFixed(2)
          }
        }
      }
    }
  });

  // default view
  applyRange('1D');

  // hook up pills
  document.getElementById('rangePills').addEventListener('click', (e)=>{
    const key = e.target?.dataset?.range;
    if (key) applyRange(key);
  });
}

initHistoryChart();
</script>
<!-- =================== END HISTORY CHART SCRIPT =================== -->

<!-- =================== EXISTING DASHBOARD SCRIPT ================== -->
<script>
// ========= Helpers =========
const fmtMoney = n => isFinite(n) ? '$' + Number(n).toFixed(2) : '‚Äì';
const fmtNum = n => isFinite(n) ? Number(n).toLocaleString() : '‚Äì';
const fmtUpdated = iso => {try{const d=new Date(iso);const date=d.toLocaleString(undefined,{month:'short',day:'2-digit'});const time=d.toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',hour12:false});return `${date}, ${time}`;}catch(e){return iso||'‚Äì';}};
const hoursOf = s => {s=String(s||'').toLowerCase();if(s.includes('year'))return 24*365;if(s.includes('6 month'))return 24*30*6;if(s.includes('3 month'))return 24*30*3;if(s.includes('month'))return 24*30;if(s.includes('week'))return 24*7;if(s.includes('day'))return 24;return 1;};

// ========= Data Stores =========
let full={}, scores=[], allProviders=[], marketAvg = NaN;

// ========= Loaders =========
async function loadJSON(url){try{const r=await fetch(url+'?t='+Date.now());if(!r.ok)throw 0;return await r.json();}catch(e){return {};}}
async function loadCSV(url){
  try{
    const r=await fetch(url+'?t='+Date.now()); if(!r.ok) return [];
    const txt=await r.text();
    const lines=txt.replace(/^\uFEFF/,'').split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
    if(!lines.length) return [];
    const parseLine=(line)=>{const out=[];let cur='';let q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"'){q=!q;}else if(c===','&&!q){out.push(cur.trim());cur='';}else{cur+=c;}}out.push(cur.trim());return out;};
    const header=parseLine(lines[0]);
    const rows=[];
    for(let i=1;i<lines.length;i++){
      const cells=parseLine(lines[i]); const obj={};
      header.forEach((h,idx)=>obj[h]=(cells[idx]||'').replace(/^"|"$/g,'').trim());
      const provider=(obj.provider||'').trim();
      const price=parseFloat((obj.effective_price_usd_per_gpu_hr||'').trim());
      if(provider && isFinite(price) && price>0) rows.push({provider, price});
    }
    return rows;
  }catch(e){return [];}
}

async function loadAll(){
  [full, scores] = await Promise.all([
    loadJSON('hcpi/hcpi_latest_full.json'),
    loadCSV('data/derived/provider_scores_latest.csv')
  ]);

  // Provider averages
  const map=new Map();
  scores.forEach(r=>{
    const prov=r.provider; const price=r.price;
    if(!prov || !isFinite(price) || price<=0) return;
    if(!map.has(prov)) map.set(prov,[]);
    map.get(prov).push(price);
  });
  allProviders = Array.from(map.entries()).map(([name,prices])=>{
    const avg = prices.reduce((a,b)=>a+b,0)/prices.length;
    return {name, avgPrice: avg, category: getCategory(name)};
  }).sort((a,b)=>a.avgPrice-b.avgPrice);

  // Market average across providers
  const allPrices = allProviders.map(p=>p.avgPrice).filter(v=>isFinite(v) && v>0);
  marketAvg = allPrices.length ? (allPrices.reduce((a,b)=>a+b,0) / allPrices.length) : NaN;
}

// ========= Categories (labels + matching) =========
const PROVIDER_CATEGORY = {
  "Big 3 Hyperscalers": new Set(["AWS","GCP","Azure","Google Cloud","Microsoft Azure"]),
  "Major GPU Clouds":   new Set(["CoreWeave","Lambda Labs","Crusoe","RunPod","Paperspace","FluidStack","Nebius"]),
  "Serverless":         new Set(["Together.ai","Replicate"]),
  "Specialized":        new Set(["Jarvislabs","Vast.ai","OVHcloud","Hyperstack","TensorDock","Voltage Park","Scaleway","Genesis Cloud","SF Compute"])
};
const getCategory = (name) => {
  for (const [cat, set] of Object.entries(PROVIDER_CATEGORY)) {
    for (const v of set) if ((name||'').toLowerCase().includes(v.toLowerCase())) return cat;
  }
  return "Other";
};
const inCategory = (name, cat) => {
  if (cat === 'All') return true;
  const set = PROVIDER_CATEGORY[cat];
  if (!set) return true;
  const n = (name || '').toLowerCase();
  for (const v of set) if (n.includes(v.toLowerCase())) return true;
  return false;
};

// ========= Index + Header =========
function currentIndex(){
  const region = document.getElementById('region').value;
  const cat    = document.getElementById('category').value;

  const ts = full?.metadata?.timestamp || null;
  document.getElementById('updated').textContent = 'Updated: ' + (ts ? fmtUpdated(ts) : '‚Äì');

  const filteredProviders = new Set(
    scores.filter(r => inCategory(r.provider, cat)).map(r => r.provider)
  );
  const fallbackCount = filteredProviders.size || new Set(scores.map(r=>r.provider)).size;
  const metaCount = full?.metadata?.unique_providers;
  document.getElementById('providerCount').textContent =
    `${(cat === 'All' && isFinite(metaCount)) ? metaCount : fallbackCount} providers tracked`;

  if (cat !== 'All') {
    const cats = full?.category_indices || {};
    const item = cats[cat] || {};
    if (region === 'US (All)') {
      return isFinite(item.category_index) ? item.category_index : NaN;
    }
    const byReg = item.regional_indices || {};
    return isFinite(byReg[region]) ? byReg[region]
         : isFinite(item.category_index) ? item.category_index
         : NaN;
  }

  if (region === 'US (All)') {
    return isFinite(full.us_index) ? full.us_index : NaN;
  }
  const reg = full.regional_indices ? full.regional_indices[region] : undefined;
  return isFinite(reg) ? reg : NaN;
}
function renderIndex(){
  const val = currentIndex();
  document.getElementById('indexVal').textContent = isFinite(val) ? fmtMoney(val) : '‚Äì';
}

// ========= Smart Insights =========
function renderInsights(){
  const box = document.getElementById('insights');
  if (!allProviders.length) { box.innerHTML = '<div class="small">No provider pricing available yet.</div>'; return; }
  const cheapest = allProviders[0];
  const avgPrice = marketAvg;
  const majorGPU = allProviders.filter(p=>getCategory(p.name)==="Major GPU Clouds").sort((a,b)=>a.avgPrice-b.avgPrice)[0];

  const insights = [
    { icon:'‚ö°', label:'Cheapest Provider', value:`${cheapest.name} ‚Ä¢ ${fmtMoney(cheapest.avgPrice)}/hr` },
    { icon:'üìä', label:'Market Average', value:`${fmtMoney(avgPrice)}/hr` },
    { icon:'üèÜ', label:'Best Value (Major Clouds)', value: majorGPU ? `${majorGPU.name} ‚Ä¢ ${fmtMoney(majorGPU.avgPrice)}/hr` : 'N/A' },
    { icon:'üí∞', label:'Potential Savings', value:`${fmtMoney(avgPrice - cheapest.avgPrice)}/GPU-hr`, subtext:'vs market average' }
  ];
  box.innerHTML = insights.map(i => `
    <div class="insight-card">
      <div class="insight-icon">${i.icon}</div>
      <div class="insight-content">
        <div class="insight-label">${i.label}</div>
        <div class="insight-value">${i.value}</div>
        ${i.subtext ? `<div style="font-size:11px;color:var(--sub);margin-top:2px">${i.subtext}</div>` : ''}
      </div>
    </div>
  `).join('');
}

// ========= Leaderboards =========
function renderLeaderboards(){
  const categories = ["Big 3 Hyperscalers", "Major GPU Clouds", "Serverless", "Specialized"];
  const categoryHTML = categories.map(cat=>{
    const inCat = allProviders.filter(p=>getCategory(p.name)===cat);
    if (!inCat.length) return '';
    const leader = inCat.sort((a,b)=>a.avgPrice-b.avgPrice)[0];
    return `
      <div class="leaderboard-item" style="cursor:pointer" onclick="useProvider('${leader.name}', ${leader.avgPrice})">
        <div class="rank gold">1</div>
        <div class="provider-info">
          <div class="provider-leader-name">${leader.name}</div>
          <div class="category-badge">${cat}</div>
        </div>
        <div style="font-size:20px;font-weight:700;color:var(--accent)">${fmtMoney(leader.avgPrice)}</div>
      </div>
    `;
  }).join('');
  document.getElementById('categoryLeaderboard').innerHTML = categoryHTML || '<div class="small">No data</div>';

  const top5 = allProviders.slice(0,5);
  const overallHTML = top5.map((p,i)=>{
    const rankClass = i===0 ? 'gold' : i===1 ? 'silver' : i===2 ? 'bronze' : '';
    return `
      <div class="leaderboard-item" style="cursor:pointer" onclick="useProvider('${p.name}', ${p.avgPrice})">
        <div class="rank ${rankClass}">${i+1}</div>
        <div class="provider-info">
          <div class="provider-leader-name">${p.name}</div>
          <div class="category-badge">${getCategory(p.name)}</div>
        </div>
        <div style="font-size:20px;font-weight:700;color:var(--accent)">${fmtMoney(p.avgPrice)}</div>
      </div>
    `;
  }).join('');
  document.getElementById('overallLeaderboard').innerHTML = overallHTML || '<div class="small">No data</div>';
}
function useProvider(name, price){
  const sel = document.getElementById('providerSelect');
  sel.value = name;
  calculateCost();
  calculateROI();
  document.getElementById('providerSelect').scrollIntoView({behavior:'smooth', block:'center'});
}
window.useProvider = useProvider;

// ========= Dropdown + Calculators =========
function renderProviderDropdown(){
  const sel = document.getElementById('providerSelect');
  sel.innerHTML = '<option value="">Select a provider</option>' + 
    allProviders.map(p=>`<option value="${p.name}" data-price="${p.avgPrice}">${p.name} - ${fmtMoney(p.avgPrice)}/hr</option>`).join('');
}
function calculateCost(){
  const sel = document.getElementById('providerSelect');
  const selectedOption = sel.options[sel.selectedIndex];
  if (!selectedOption || !selectedOption.value) {
    document.getElementById('costPrice').textContent = '‚Äì';
    document.getElementById('costHours').textContent = '‚Äì';
    document.getElementById('costGPUHours').textContent = '‚Äì';
    document.getElementById('costTotal').textContent = '‚Äì';
    return null;
  }
  const price = parseFloat(selectedOption.dataset.price);
  const count = Number(document.getElementById('count').value) || 0;
  const hrs = hoursOf(document.getElementById('duration').value);
  const gpuHours = count * hrs;
  const totalCost = price * gpuHours;

  document.getElementById('costPrice').textContent = fmtMoney(price) + '/hr';
  document.getElementById('costHours').textContent = fmtNum(hrs) + ' hrs';
  document.getElementById('costGPUHours').textContent = fmtNum(gpuHours);
  document.getElementById('costTotal').textContent = fmtMoney(totalCost);
  return {price, totalCost, gpuHours};
}

// ========= ROI (1 / price) =========
function roiValuePerDollar(pricePerHr){
  return (isFinite(pricePerHr) && pricePerHr > 0) ? (1 / pricePerHr) : NaN;
}
function calculateROI(){
  const sel = document.getElementById('providerSelect');
  const opt = sel.options[sel.selectedIndex];

  const price = opt && opt.value ? parseFloat(opt.dataset.price) : NaN;
  const providerEl = document.getElementById('roiProviderPrice');
  const roiEl      = document.getElementById('roiBasic');
  const rankEl     = document.getElementById('roiRank');

  const utilRow = document.getElementById('roiUtilRow');
  utilRow.style.display = 'none';

  providerEl.textContent = isFinite(price) ? fmtMoney(price) + '/hr' : '‚Äì';

  if (!isFinite(price)) {
    roiEl.textContent = '‚Äì';
    rankEl.textContent = '‚Äì';
    return;
  }

  const roi = roiValuePerDollar(price);
  roiEl.textContent = isFinite(roi) ? roi.toFixed(3) : '‚Äì';
  roiEl.className = 'metric-value ' + (roi > 0 ? 'positive' : '');

  const roiList = allProviders
    .map(p => ({ name: p.name, roi: roiValuePerDollar(p.avgPrice) }))
    .filter(x => isFinite(x.roi))
    .sort((a,b)=> b.roi - a.roi);

  const idx = roiList.findIndex(x => x.name === opt.value);
  if (idx >= 0 && roiList.length > 0) {
    const percentile = ((roiList.length - idx) / roiList.length) * 100;
    rankEl.textContent = `Top ${percentile.toFixed(0)}%`;
  } else {
    rankEl.textContent = '‚Äì';
  }
}

// ========= Workload Estimator =========
function calculateWorkload(){
  const workloadInput = Number(document.getElementById('workloadGPUHours').value) || 0;
  const unit = document.getElementById('workloadUnit').value;
  let gpuHours = workloadInput;
  if (unit.includes('days')) gpuHours *= 24;
  if (unit.includes('weeks')) gpuHours *= 24 * 7;
  if (gpuHours <= 0) { document.getElementById('workloadResults').style.display = 'none'; return; }
  
  const results = allProviders.map(p => ({
    name: p.name,
    pricePerHr: p.avgPrice,
    totalCost: p.avgPrice * gpuHours
  })).sort((a,b)=>a.totalCost-b.totalCost);
  
  const cheapest = results[0].totalCost;
  const tbody = document.getElementById('workloadTableBody');
  tbody.innerHTML = results.map((r,i)=>{
    const diff = r.totalCost - cheapest;
    const diffPct = cheapest>0 ? (diff/cheapest)*100 : 0;
    const isCheapest = i===0;
    return `<tr style="border-bottom:1px solid #2c3240">
        <td style="padding:8px">${isCheapest?'<span style="color:var(--ok);margin-right:4px">‚òÖ</span>':''}${r.name}</td>
        <td style="padding:8px;text-align:right">${fmtMoney(r.pricePerHr)}</td>
        <td style="padding:8px;text-align:right;font-weight:600">${fmtMoney(r.totalCost)}</td>
        <td style="padding:8px;text-align:right;color:${isCheapest?'var(--ok)': diff>cheapest*0.5?'#ff6b6b':'var(--warn)'}">${isCheapest?'Cheapest':'+'+fmtMoney(diff)+' (+'+diffPct.toFixed(0)+'%)'}</td>
      </tr>`;
  }).join('');
  
  document.getElementById('workloadResults').style.display = 'block';
}

// ========= Listeners & Boot =========
function setupListeners(){
  document.getElementById('region').addEventListener('change', ()=>{ renderIndex(); });
  document.getElementById('category').addEventListener('change', ()=>{ renderIndex(); });
  document.getElementById('btnRefresh').addEventListener('click', ()=>{ renderIndex(); });

  document.getElementById('providerSelect').addEventListener('change', ()=>{ calculateCost(); calculateROI(); });
  document.getElementById('count').addEventListener('input', ()=>{ calculateCost(); });
  document.getElementById('duration').addEventListener('change', ()=>{ calculateCost(); });

  document.getElementById('btnWorkload').addEventListener('click', calculateWorkload);
  document.getElementById('workloadGPUHours').addEventListener('input', calculateWorkload);
  document.getElementById('workloadUnit').addEventListener('change', calculateWorkload);
}

async function boot(){
  await loadAll();
  renderIndex();
  renderInsights();
  renderLeaderboards();
  renderProviderDropdown();
  setupListeners();
  calculateROI(); // initial paint
}
boot();
</script>
</body>
</html>

